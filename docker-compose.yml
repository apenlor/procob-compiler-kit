services:
  compiler:
    image: procob-compiler:latest
    build:
      context: .
      target: compiler
    # Enforce AMD64 architecture for Oracle binary compatibility
    platform: linux/amd64
    volumes:
      # Mount local workspace to container application directory
      # Create this folder in your project if you don't want to lose your code when closing docker
      - ./workspace:/app
    environment:
      - ORACLE_HOME=/opt/oracle/instantclient
      - LD_LIBRARY_PATH=/opt/oracle/instantclient
      - COB_LIBRARY_PATH=/app/bin
    tty: true
    stdin_open: true

  runner:
    image: procob-runner:latest
    build:
      context: .
      target: runner
    platform: linux/amd64
    volumes:
      - ./workspace:/app
    environment:
      - ORACLE_HOME=/opt/oracle/instantclient
      - LD_LIBRARY_PATH=/opt/oracle/instantclient
      - COB_LIBRARY_PATH=/app/bin
    depends_on:
      oracle-db:
        condition: service_healthy
    tty: true
    stdin_open: true

  oracle-db:
    image: container-registry.oracle.com/database/free:latest
    mem_limit: "3g"
    shm_size: "1g"
    environment:
      - ORACLE_PWD=Welcome1
    ports:
      - "1521:1521"
    volumes:
      - oracle-data:/opt/oracle/oradata
      # Mount custom setup scripts to be executed on database creation
      - ./resources/oracle/setup:/opt/oracle/scripts/startup
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/127.0.0.1/1521' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 2m

volumes:
  oracle-data:
